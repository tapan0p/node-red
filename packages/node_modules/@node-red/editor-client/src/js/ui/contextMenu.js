RED.contextMenu = (function () {

    let menu;
    let edgeConditions = {};

    function showConnectionDialog(link, condition) {
        try {
            // Create dialog content with more node-like styling
            var dialogContent = $('<div class="red-ui-edit-connection-dialog dialog-form"></div>');
            
            // Create header and description
            dialogContent.append('<div class="form-row" style="margin-bottom:15px"><i class="fa fa-route"></i> Configure conditional routing based on triplets or message properties.</div>');
            
            // Create settings tab structure (similar to node settings)
            var tabs = $('<ul class="red-ui-editor-dialog-tab-list"></ul>').appendTo(dialogContent);
            var settingsTab = $('<li><a href="#connection-settings-tab"><span>Settings</span></a></li>').appendTo(tabs);
            var tripletsTab = $('<li><a href="#connection-triplets-tab"><span>Triplets</span></a></li>').appendTo(tabs);
            
            // Settings tab content
            var settingsTabContent = $('<div id="connection-settings-tab" class="red-ui-editor-dialog-tab-content"></div>').appendTo(dialogContent);
            
            // Enable checkbox
            var enabledContainer = $('<div class="form-row" style="margin-bottom:15px"></div>').appendTo(settingsTabContent);
            var enabledCheckbox = $('<input type="checkbox" id="node-edge-enabled" style="width:auto; margin-right:5px;">').appendTo(enabledContainer);
            $('<label for="node-edge-enabled">Enable conditional routing</label>').appendTo(enabledContainer);
            
            // Set initial enabled state
            enabledCheckbox.prop('checked', condition.enabled || false);
            
            // Create condition fields
            var conditionRow = $('<div class="form-row edge-condition-row"></div>').appendTo(settingsTabContent);
            
            // If condition is currently disabled, hide the condition row initially
            if (!condition.enabled) {
                conditionRow.hide();
            }
            
            // Create property field with TypedInput if available
            var propertyRow = $('<div class="form-row" style="margin-bottom:15px"></div>').appendTo(conditionRow);
            $('<label style="width:100px">Property</label>').appendTo(propertyRow);
            var propertyField = $('<input type="text" id="node-edge-property" style="width:70%">').appendTo(propertyRow);
            
            // Set initial property value
            propertyField.val(condition.property || 'payload');
            
            // Add TypedInput to property if available
            if (typeof RED.editor.typedInput !== 'undefined') {
                propertyField.typedInput({
                    default: 'msg',
                    types: ['msg', 'flow', 'global'],
                    typeField: $('<input type="hidden" id="node-edge-property-type">').appendTo(propertyRow)
                });
            }
            
            // Create operator dropdown
            var operatorRow = $('<div class="form-row" style="margin-bottom:15px"></div>').appendTo(conditionRow);
            $('<label style="width:100px">Operator</label>').appendTo(operatorRow);
            var operatorField = $('<select id="node-edge-operator" style="width:70%"></select>').appendTo(operatorRow);
            
            // Add operator options
            var operators = [
                {value: "eq", label: "equals"},
                {value: "neq", label: "not equals"},
                {value: "lt", label: "less than"},
                {value: "lte", label: "less than or equal to"},
                {value: "gt", label: "greater than"},
                {value: "gte", label: "greater than or equal to"},
                {value: "contains", label: "contains"},
                {value: "startsWith", label: "starts with"},
                {value: "endsWith", label: "ends with"},
                {value: "regex", label: "matches regex"}
            ];
            
            // Add each operator to the dropdown
            operators.forEach(function(op) {
                operatorField.append('<option value="' + op.value + '">' + op.label + '</option>');
            });
            
            // Set initial operator value
            operatorField.val(condition.operator || 'eq');
            
            // Create value field
            var valueRow = $('<div class="form-row" style="margin-bottom:15px"></div>').appendTo(conditionRow);
            $('<label style="width:100px">Value</label>').appendTo(valueRow);
            var valueField = $('<input type="text" id="node-edge-value" style="width:70%">').appendTo(valueRow);
            
            // Set initial value
            valueField.val(condition.value || '');
            
            // Add value type selector (using TypedInput if available)
            var valueTypeField;
            if (typeof RED.editor.typedInput !== 'undefined') {
                valueField.typedInput({
                    default: condition.valueType || 'str',
                    types: ['str', 'num', 'bool', 'json', 'msg', 'flow', 'global'],
                    typeField: $('<input type="hidden" id="node-edge-value-type">').appendTo(valueRow)
                });
                
                // Set initial value type
                valueField.typedInput('type', condition.valueType || 'str');
            } else {
                // Fallback to simple select
                valueTypeField = $('<select id="node-edge-value-type" style="width:120px; margin-left:5px"></select>').appendTo(valueRow);
                
                // Add type options
                var types = [
                    {value: "str", label: "String"},
                    {value: "num", label: "Number"},
                    {value: "bool", label: "Boolean"},
                    {value: "json", label: "JSON"}
                ];
                
                // Add each type to the dropdown
                types.forEach(function(type) {
                    valueTypeField.append('<option value="' + type.value + '">' + type.label + '</option>');
                });
                
                // Set initial value type
                valueTypeField.val(condition.valueType || 'str');
            }
            
            // Triplets tab content
            var tripletsTabContent = $('<div id="connection-triplets-tab" class="red-ui-editor-dialog-tab-content"></div>').appendTo(dialogContent);
            
            // Check if the source node is a triplets node
            var isTripletsNode = link.source.type === 'triplets';
            
            if (isTripletsNode) {
                // Create triplet condition options
                var tripletInfoRow = $('<div class="form-row"><div class="form-tips">Configure conditions based on triplets created by the source node.</div></div>').appendTo(tripletsTabContent);
                
                // Create triplet subject field
                var subjectRow = $('<div class="form-row" style="margin-bottom:15px"></div>').appendTo(tripletsTabContent);
                $('<label style="width:100px">Subject</label>').appendTo(subjectRow);
                var subjectField = $('<input type="text" id="node-edge-triplet-subject" style="width:70%">').appendTo(subjectRow);
                
                // Set initial subject value
                subjectField.val(condition.tripletSubject || '');
                
                // Create triplet predicate field
                var predicateRow = $('<div class="form-row" style="margin-bottom:15px"></div>').appendTo(tripletsTabContent);
                $('<label style="width:100px">Predicate</label>').appendTo(predicateRow);
                var predicateField = $('<input type="text" id="node-edge-triplet-predicate" style="width:70%">').appendTo(predicateRow);
                
                // Set initial predicate value
                predicateField.val(condition.tripletPredicate || '');
                
                // Create triplet object field
                var objectRow = $('<div class="form-row" style="margin-bottom:15px"></div>').appendTo(tripletsTabContent);
                $('<label style="width:100px">Object</label>').appendTo(objectRow);
                var objectField = $('<input type="text" id="node-edge-triplet-object" style="width:70%">').appendTo(objectRow);
                
                // Set initial object value
                objectField.val(condition.tripletObject || '');
                
                // Add explanation about wildcards
                var wildcardRow = $('<div class="form-row"><div class="form-tips">Leave a field blank to match any value. All specified fields must match for the condition to pass.</div></div>').appendTo(tripletsTabContent);
            } else {
                // Show a message that triplets are only available from triplets nodes
                var notTripletsRow = $('<div class="form-row"><div class="form-tips">Triplets filtering is only available when the source node is a Triplets node.</div></div>').appendTo(tripletsTabContent);
            }
            
            // Handle enabled checkbox change
            enabledCheckbox.change(function() {
                if ($(this).is(':checked')) {
                    conditionRow.show();
                } else {
                    conditionRow.hide();
                }
            });
            
            // Initialize the tabs
            if (typeof RED.tabs !== 'undefined') {
                RED.tabs.create({
                    element: tabs,
                    onchange: function(tab, tabContent) {
                        $('#connection-settings-tab').hide();
                        $('#connection-triplets-tab').hide();
                        $(tabContent).show();
                    }
                });
            } else {
                // Fallback tab functionality
                settingsTab.find('a').on('click', function(e) {
                    e.preventDefault();
                    $('#connection-triplets-tab').hide();
                    $('#connection-settings-tab').show();
                    tabs.find('li').removeClass('active');
                    settingsTab.addClass('active');
                });
                
                tripletsTab.find('a').on('click', function(e) {
                    e.preventDefault();
                    $('#connection-settings-tab').hide();
                    $('#connection-triplets-tab').show();
                    tabs.find('li').removeClass('active');
                    tripletsTab.addClass('active');
                });
                
                // Default to settings tab
                settingsTab.find('a').trigger('click');
            }
            
            // Create the dialog
            var buttons = [
                {
                    id: "node-dialog-cancel",
                    text: "Cancel",
                    click: function() {
                        RED.editor.editDialogClosed();
                    }
                },
                {
                    id: "node-dialog-ok",
                    text: "Done",
                    class: "primary",
                    click: function() {
                        // Save the condition
                        condition.enabled = enabledCheckbox.prop('checked');
                        condition.property = propertyField.val();
                        condition.operator = operatorField.val();
                        condition.value = valueField.val();
                        
                        // Get value type
                        if (typeof RED.editor.typedInput !== 'undefined') {
                            condition.valueType = valueField.typedInput('type');
                        } else if (valueTypeField) {
                            condition.valueType = valueTypeField.val();
                        }
                        
                        // Save triplet-specific conditions if the source is a triplets node
                        if (isTripletsNode) {
                            condition.tripletSubject = subjectField.val();
                            condition.tripletPredicate = predicateField.val();
                            condition.tripletObject = objectField.val();
                            condition.useTriplets = (condition.tripletSubject || condition.tripletPredicate || condition.tripletObject) ? true : false;
                        }
                        
                        // Close the dialog
                        RED.editor.editDialogClosed();
                        
                        // Update the link appearance to show it's conditional
                        updateLinkAppearance(link, condition);
                        
                        // Save conditions to flow
                        saveEdgeConditionsToFlow();
                        
                        // Mark the workspace as dirty
                        RED.nodes.dirty(true);
                    }
                }
            ];
            
            if (typeof RED.editor.editDialog === 'function') {
                RED.editor.editDialog({
                    title: "Edit Connection",
                    body: dialogContent,
                    buttons: buttons
                });
            } else {
                // Fallback dialog using jQuery UI or custom modal
                tryCreateDialogWithFallbacks(dialogContent, condition, link, buttons);
            }
        } catch (error) {
            console.error("Error showing connection dialog:", error);
            RED.notify("Error showing connection dialog: " + error.toString(), "error");
        }
    }
    
    // Helper function to try various dialog creation methods
    function tryCreateDialogWithFallbacks(dialogContent, condition, link, buttons) {
        try {
            // Try jQuery UI Dialog if available
            console.log("Using jQuery UI dialog fallback");
            
            // Convert RED buttons to jQuery UI format
            var dialogButtons = buttons.map(function(btn) {
                return {
                    text: btn.text,
                    class: btn.class || '',
                    click: btn.click
                };
            });
            
            dialogContent.dialog({
                title: "Edit Connection",
                modal: true,
                width: 500,
                resizable: false,
                buttons: dialogButtons,
                open: function() {
                    // Ensure tabs work correctly in jQuery UI dialog
                    $('#connection-settings-tab').show();
                    $('#connection-triplets-tab').hide();
                }
            });
        } catch (error) {
            // Last resort: create a custom modal dialog
            console.error("Error creating jQuery UI dialog:", error);
            console.log("Using custom modal fallback");
            
            // Create a simple modal container
            var modalContainer = $('<div class="red-ui-edit-connection-dialog-container"></div>').css({
                'position': 'fixed',
                'top': 0,
                'left': 0,
                'right': 0,
                'bottom': 0,
                'background': 'rgba(0,0,0,0.7)',
                'z-index': 1000,
                'display': 'flex',
                'justify-content': 'center',
                'align-items': 'center'
            }).appendTo('body');
            
            // Create the dialog box
            var modalDialog = $('<div></div>').css({
                'background': 'white',
                'border-radius': '5px',
                'padding': '20px',
                'max-width': '500px',
                'width': '100%',
                'box-shadow': '0 0 10px rgba(0,0,0,0.5)'
            }).appendTo(modalContainer);
            
            // Add title
            $('<h3>Edit Connection</h3>').css({
                'margin-top': 0,
                'margin-bottom': '20px'
            }).appendTo(modalDialog);
            
            // Add content
            dialogContent.appendTo(modalDialog);
            
            // Ensure tabs work correctly in custom dialog
            $('#connection-settings-tab').show();
            $('#connection-triplets-tab').hide();
            
            // Add buttons
            var buttonContainer = $('<div></div>').css({
                'text-align': 'right',
                'margin-top': '20px'
            }).appendTo(modalDialog);
            
            // Add buttons in reverse order so primary is on the right
            for (var i = buttons.length - 1; i >= 0; i--) {
                var btn = buttons[i];
                var btnElement = $('<button>' + btn.text + '</button>').css({
                    'margin-left': '10px',
                    'padding': '8px 15px'
                });
                
                if (btn.class === 'primary') {
                    btnElement.css({
                        'background': '#a6bbcf',
                        'color': 'white',
                        'border': 'none',
                        'border-radius': '3px',
                        'font-weight': 'bold'
                    });
                }
                
                // Use IIFE to capture the current button's click handler
                (function(clickHandler) {
                    btnElement.click(function() {
                        clickHandler();
                        modalContainer.remove();
                    });
                })(btn.click);
                
                btnElement.appendTo(buttonContainer);
            }
            
            // Close when clicking outside
            modalContainer.click(function(event) {
                if (event.target === modalContainer[0]) {
                    modalContainer.remove();
                }
            });
        }
    }
    
    // Update the link appearance based on whether it has conditions enabled
    function updateLinkAppearance(link, condition) {
        var linkId = link.source.id + ':' + link.sourcePort + ':' + link.target.id;
        var linkElement = $('.red-ui-flow-link[id$="' + linkId + '"]');
        
        if (condition.enabled) {
            // Make the link dashed to show it's conditional
            linkElement.css('stroke-dasharray', '5,2');
            
            // Add a class for later reference
            linkElement.addClass('red-ui-conditional-link');
            
            // Store data on the link for evaluation
            link._condition = condition;
        } else {
            // Reset to solid line
            linkElement.css('stroke-dasharray', 'none');
            
            // Remove the class
            linkElement.removeClass('red-ui-conditional-link');
            
            // Remove the condition data
            delete link._condition;
        }
    }

    // Evaluate a condition against a message
    function evaluateCondition(condition, msg) {
        if (!condition || !condition.enabled) {
            return true; // If condition is disabled, always pass
        }
        
        // Check for triplet conditions first
        if (condition.useTriplets && msg.triplets && Array.isArray(msg.triplets)) {
            return evaluateTripletCondition(condition, msg.triplets);
        }
        
        // Get property value using RED.utils.getMessageProperty if available
        var propertyValue;
        if (typeof RED.utils.getMessageProperty === 'function') {
            propertyValue = RED.utils.getMessageProperty(msg, condition.property);
        } else {
            // Simple property getter as fallback
            propertyValue = msg[condition.property];
        }
        
        // Convert the target value based on its type
        var targetValue = condition.value;
        switch (condition.valueType) {
            case 'num':
                targetValue = Number(targetValue);
                break;
            case 'bool':
                targetValue = (targetValue === 'true' || targetValue === true);
                break;
            case 'json':
                try {
                    targetValue = JSON.parse(targetValue);
                } catch(e) {
                    // Keep as string if JSON parsing fails
                }
                break;
        }
        
        // Evaluate based on operator
        switch (condition.operator) {
            case 'eq':
                return propertyValue == targetValue;
            case 'neq':
                return propertyValue != targetValue;
            case 'lt':
                return propertyValue < targetValue;
            case 'lte':
                return propertyValue <= targetValue;
            case 'gt':
                return propertyValue > targetValue;
            case 'gte':
                return propertyValue >= targetValue;
            case 'contains':
                return String(propertyValue).includes(String(targetValue));
            case 'startsWith':
                return String(propertyValue).startsWith(String(targetValue));
            case 'endsWith':
                return String(propertyValue).endsWith(String(targetValue));
            case 'regex':
                try {
                    var regex = new RegExp(targetValue);
                    return regex.test(String(propertyValue));
                } catch(e) {
                    return false;
                }
            default:
                return true;
        }
    }
    
    // Evaluate a triplet-specific condition
    function evaluateTripletCondition(condition, triplets) {
        // If no triplets, the condition fails
        if (!triplets || !Array.isArray(triplets) || triplets.length === 0) {
            return false;
        }
        
        var subject = condition.tripletSubject;
        var predicate = condition.tripletPredicate;
        var object = condition.tripletObject;
        
        // Empty condition matches any triplet
        if (!subject && !predicate && !object) {
            return true;
        }
        
        // Check if any triplet matches the condition
        for (var i = 0; i < triplets.length; i++) {
            var triplet = triplets[i];
            
            // Skip invalid triplets
            if (!triplet || typeof triplet !== 'object') {
                continue;
            }
            
            // Check subject (if specified)
            if (subject && triplet.subject !== subject) {
                continue;
            }
            
            // Check predicate (if specified)
            if (predicate && triplet.predicate !== predicate) {
                continue;
            }
            
            // Check object (if specified)
            if (object && triplet.object !== object) {
                continue;
            }
            
            // If we got here, all specified conditions match
            return true;
        }
        
        // No matching triplet found
        return false;
    }
    
    // Save edge conditions to flow configuration
    function saveEdgeConditionsToFlow() {
        RED.settings.set('edgeConditions', edgeConditions);
    }
    
    // Load edge conditions from flow configuration
    function loadEdgeConditionsFromFlow() {
        var savedConditions = RED.settings.get('edgeConditions');
        if (savedConditions) {
            edgeConditions = savedConditions;
            
            // Apply conditions to links
            RED.nodes.eachLink(function(link) {
                var linkId = link.source.id + ':' + link.sourcePort + ':' + link.target.id;
                if (edgeConditions[linkId]) {
                    updateLinkAppearance(link, edgeConditions[linkId]);
                }
            });
        }
    }
    
    // Apply conditions when messages are sent through links
    function setupConditionalWiring() {
        // Store the original RED.nodes.addLink function
        var originalAddLink = RED.nodes.addLink;
        
        // Override RED.nodes.addLink to add condition evaluation
        RED.nodes.addLink = function(link) {
            // Call the original function
            var result = originalAddLink.apply(this, arguments);
            
            // Get the link ID
            var linkId = link.source.id + ':' + link.sourcePort + ':' + link.target.id;
            
            // If this link has a condition, store it on the link object
            if (edgeConditions[linkId] && edgeConditions[linkId].enabled) {
                link._condition = edgeConditions[linkId];
                
                // Update the link appearance
                updateLinkAppearance(link, edgeConditions[linkId]);
            }
            
            return result;
        };
        
        // Hook into the Node-RED runtime to evaluate conditions
        // This will be loaded when the flow is deployed
        RED.comms.subscribe("edge-condition-evaluate", function(topic, msg) {
            var linkId = msg.linkId;
            var condition = edgeConditions[linkId];
            var result = evaluateCondition(condition, msg.msg);
            
            // Send the result back to the runtime
            RED.comms.publish("edge-condition-result", {
                linkId: linkId,
                result: result,
                msgId: msg.msgId
            });
        });
    }

    function disposeMenu() {
        $(document).off("mousedown.red-ui-workspace-context-menu");
        if (menu) {
            menu.remove();
        }
        menu = null;
    }
    function show(options) {
        if (menu) {
            menu.remove()
        }
        let menuItems = []
        if (options.options) {
            menuItems = options.options
        } else if (options.type === 'workspace') {
            const selection = RED.view.selection()
            const noSelection = !selection || Object.keys(selection).length === 0
            const hasSelection = (selection.nodes && selection.nodes.length > 0);
            const hasMultipleSelection = hasSelection && selection.nodes.length > 1;
            const virtulLinks = (selection.links && selection.links.filter(e => !!e.link)) || [];
            const wireLinks = (selection.links && selection.links.filter(e => !e.link)) || [];
            const hasLinks = wireLinks.length > 0;
            const isSingleLink = !hasSelection && hasLinks && wireLinks.length === 1
            const isMultipleLinks = !hasSelection && hasLinks && wireLinks.length > 1
            const canDelete = hasSelection || hasLinks
            const isGroup = hasSelection && selection.nodes.length === 1 && selection.nodes[0].type === 'group'
            const canEdit = !RED.workspaces.isLocked()
            const canRemoveFromGroup = hasSelection && !!selection.nodes[0].g
            
            // ADD EDIT CONNECTION OPTION FOR LINKS
            if (hasLinks) {
                // Add the Edit Connection option at the top of the menu
                menuItems.push(
                    {
                        label: "Edit Connection",
                        onselect: function() {
                            try {
                                // Get the selected link
                                var selectedLink = wireLinks[0];
                                
                                // Get the link ID
                                var linkId = selectedLink.source.id + ':' + selectedLink.sourcePort + ':' + selectedLink.target.id;
                                
                                // Get or create the condition data
                                if (!edgeConditions[linkId]) {
                                    edgeConditions[linkId] = {
                                        property: "payload",
                                        operator: "eq",
                                        value: "",
                                        valueType: "str",
                                        enabled: false
                                    };
                                }
                                
                                console.log("Showing connection dialog for link:", linkId);
                                
                                // Show the dialog directly using the RED.editConnection function
                                setTimeout(function() {
                                    RED.editConnection(selectedLink);
                                }, 100);
                            } catch(err) {
                                console.error("Error opening connection dialog:", err);
                                RED.notify("Error opening connection dialog: " + err.toString(), "error");
                            }
                        }
                    }
                );
                // Add a separator
                menuItems.push(null);
            }
            
            let hasGroup, isAllGroups = true, hasDisabledNode, hasEnabledNode, hasLabeledNode, hasUnlabeledNode;
            if (hasSelection) {
                const nodes = selection.nodes.slice();
                while (nodes.length) {
                    const n = nodes.shift();
                    if (n.type === 'group') {
                        hasGroup = true;
                        nodes.push(...n.nodes);
                    } else {
                        isAllGroups = false;
                        if (n.d) {
                            hasDisabledNode = true;
                        } else {
                            hasEnabledNode = true;
                        }
                    }
                    if (n.l === undefined || n.l) {
                        hasLabeledNode = true;
                    } else {
                        hasUnlabeledNode = true;
                    }
                }
            }

            const scale = RED.view.scale()
            const offset = $("#red-ui-workspace-chart").offset()
            let addX = (options.x - offset.left + $("#red-ui-workspace-chart").scrollLeft()) / scale
            let addY = (options.y - offset.top + $("#red-ui-workspace-chart").scrollTop()) / scale

            if (RED.view.snapGrid) {
                const gridSize = RED.view.gridSize()
                addX = gridSize * Math.round(addX / gridSize)
                addY = gridSize * Math.round(addY / gridSize)
            }

            if (RED.settings.theme("menu.menu-item-action-list", true)) {
                menuItems.push(
                    { onselect: 'core:show-action-list', label: RED._("contextMenu.showActionList"), onpostselect: function () { } }
                )
            }
            const insertOptions = []
            menuItems.push({ label: RED._("contextMenu.insert"), options: insertOptions })
            insertOptions.push(
                {
                    label: RED._("contextMenu.node"),
                    onselect: function () {
                        RED.view.showQuickAddDialog({
                            position: [addX, addY],
                            touchTrigger: 'ontouchstart' in window,
                            splice: isSingleLink ? selection.links[0] : undefined,
                            // spliceMultiple: isMultipleLinks
                        })
                    },
                    disabled: !canEdit
                },
                (hasLinks) ? { // has least 1 wire selected
                    label: RED._("contextMenu.junction"),
                    onselect: function () {
                        RED.actions.invoke('core:split-wires-with-junctions', { x: addX, y: addY })
                    },
                    disabled: !canEdit || !hasLinks
                } : {
                    label: RED._("contextMenu.junction"),
                    onselect: function () {
                        const nn = {
                            _def: { defaults: {} },
                            type: 'junction',
                            z: RED.workspaces.active(),
                            id: RED.nodes.id(),
                            x: addX,
                            y: addY,
                            w: 0, h: 0,
                            outputs: 1,
                            inputs: 1,
                            dirty: true,
                            moved: true
                        }
                        const junction = RED.nodes.addJunction(nn);
                        const historyEvent = {
                            dirty: RED.nodes.dirty(),
                            t: 'add',
                            junctions: [junction]
                        }
                        RED.history.push(historyEvent);
                        RED.nodes.dirty(true);
                        RED.view.select({nodes: [junction] });
                        RED.view.redraw(true)
                    },
                    disabled: !canEdit
                },
                {
                    label: RED._("contextMenu.linkNodes"),
                    onselect: 'core:split-wire-with-link-nodes',
                    disabled: !canEdit || !hasLinks
                },
                null
            )
            if (RED.settings.theme("menu.menu-item-import-library", true)) {
                insertOptions.push(
                    { onselect: 'core:show-import-dialog', label: RED._('common.label.import')},
                    { onselect: 'core:show-examples-import-dialog', label: RED._('menu.label.importExample') }
                )
            }


            if (hasSelection && canEdit) {
                const nodeOptions = []
                if (!hasMultipleSelection && !isGroup) {
                    nodeOptions.push(
                        { onselect: 'core:show-node-help', label: RED._('menu.label.showNodeHelp') },
                        null
                    )
                }
                nodeOptions.push(
                    { onselect: 'core:enable-selected-nodes', label: RED._('menu.label.enableSelectedNodes'), disabled: !hasDisabledNode },
                    { onselect: 'core:disable-selected-nodes', label: RED._('menu.label.disableSelectedNodes'), disabled: !hasEnabledNode },
                    null,
                    { onselect: 'core:show-selected-node-labels', label: RED._('menu.label.showSelectedNodeLabels'), disabled: !hasUnlabeledNode },
                    { onselect: 'core:hide-selected-node-labels', label: RED._('menu.label.hideSelectedNodeLabels'), disabled: !hasLabeledNode }
                )
                menuItems.push({
                    label: RED._('sidebar.info.node'),
                    options: nodeOptions
                })
                menuItems.push({
                    label: RED._('sidebar.info.group'),
                    options: [
                        { onselect: 'core:group-selection', label: RED._("menu.label.groupSelection") },
                        { onselect: 'core:ungroup-selection', label: RED._("menu.label.ungroupSelection"), disabled: !hasGroup },
                    ]
                })
                if (hasGroup) {
                    menuItems[menuItems.length - 1].options.push(
                        { onselect: 'core:merge-selection-to-group', label: RED._("menu.label.groupMergeSelection") }
                    )

                }
                if (canRemoveFromGroup) {
                    menuItems[menuItems.length - 1].options.push(
                        { onselect: 'core:remove-selection-from-group', label: RED._("menu.label.groupRemoveSelection") }
                    )
                }
                menuItems[menuItems.length - 1].options.push(
                    null,
                    { onselect: 'core:copy-group-style', label: RED._("keyboard.copyGroupStyle"), disabled: !hasGroup },
                    { onselect: 'core:paste-group-style', label: RED._("keyboard.pasteGroupStyle"), disabled: !hasGroup}
                )
            }
            if (canEdit && hasMultipleSelection) {
                menuItems.push({
                    label: RED._('menu.label.arrange'),
                    options: [
                        { label:RED._("menu.label.alignLeft"), onselect: "core:align-selection-to-left"},
                        { label:RED._("menu.label.alignCenter"), onselect: "core:align-selection-to-center"},
                        { label:RED._("menu.label.alignRight"), onselect: "core:align-selection-to-right"},
                        null,
                        { label:RED._("menu.label.alignTop"), onselect: "core:align-selection-to-top"},
                        { label:RED._("menu.label.alignMiddle"), onselect: "core:align-selection-to-middle"},
                        { label:RED._("menu.label.alignBottom"), onselect: "core:align-selection-to-bottom"},
                        null,
                        { label:RED._("menu.label.distributeHorizontally"), onselect: "core:distribute-selection-horizontally"},
                        { label:RED._("menu.label.distributeVertically"), onselect: "core:distribute-selection-vertically"}
                    ]
                })
            }


            menuItems.push(
                null,
                { onselect: 'core:undo', label: RED._("keyboard.undoChange"), disabled: RED.history.list().length === 0 },
                { onselect: 'core:redo', label: RED._("keyboard.redoChange"), disabled: RED.history.listRedo().length === 0 },
                null,
                { onselect: 'core:cut-selection-to-internal-clipboard', label: RED._("keyboard.cutNode"), disabled: !canEdit || !hasSelection },
                { onselect: 'core:copy-selection-to-internal-clipboard', label: RED._("keyboard.copyNode"), disabled: !hasSelection },
                { onselect: 'core:paste-from-internal-clipboard', label: RED._("keyboard.pasteNode"), disabled: !canEdit || !RED.view.clipboard() },
                { onselect: 'core:delete-selection', label: RED._('keyboard.deleteSelected'), disabled: !canEdit || !canDelete },
                { onselect: 'core:delete-selection-and-reconnect', label: RED._('keyboard.deleteReconnect'), disabled: !canEdit || !canDelete },
            )
            if (RED.settings.theme("menu.menu-item-export-library", true)) {
                menuItems.push(
                    { onselect: 'core:show-export-dialog', label: RED._("menu.label.export") }
                )
            }
            menuItems.push(
                { onselect: 'core:select-all-nodes', label: RED._("keyboard.selectAll") }
            )
        }

        var direction = "right";
        var MENU_WIDTH = 500; // can not use menu width here
        if ((options.x -$(document).scrollLeft()) >
            ($(window).width() -MENU_WIDTH)) {
            direction = "left";
        }

        menu = RED.menu.init({
            direction: direction,
            onpreselect: function() {
                disposeMenu()
            },
            onpostselect: function () {
                RED.view.focus()
            },
            options: menuItems
        });

        menu.attr("id", "red-ui-workspace-context-menu");
        menu.css({
            position: "absolute"
        })
        menu.appendTo("body");

        // TODO: prevent the menu from overflowing the window.

        var top = options.y
        var left = options.x

        if (top + menu.height() - $(document).scrollTop() > $(window).height()) {
            top -= (top + menu.height()) - $(window).height() + 22;
        }
        if (left + menu.width() - $(document).scrollLeft() > $(window).width()) {
            left -= (left + menu.width()) - $(window).width() + 18;
        }
        menu.css({
            top: top + "px",
            left: left + "px"
        })
        $(".red-ui-menu.red-ui-menu-dropdown").hide();
        $(document).on("mousedown.red-ui-workspace-context-menu", function (evt) {
            if (menu && menu[0].contains(evt.target)) {
                return
            }
            disposeMenu()
        });
        menu.show();
        // set focus to first item so that pressing escape key closes the menu
        $("#red-ui-workspace-context-menu :first(ul) > a").trigger("focus")

    }
    // Allow escape key hook and other editor events to close context menu
    RED.keyboard.add("red-ui-workspace-context-menu", "escape", function () { RED.contextMenu.hide() })
    RED.events.on("editor:open", function () { RED.contextMenu.hide() });
    RED.events.on("search:open", function () { RED.contextMenu.hide() });
    RED.events.on("type-search:open", function () { RED.contextMenu.hide() });
    RED.events.on("actionList:open", function () { RED.contextMenu.hide() });
    RED.events.on("view:selection-changed", function () { RED.contextMenu.hide() });
    
    // Initialize the conditional connection system
    $(function() {
        // Load any saved edge conditions
        loadEdgeConditionsFromFlow();
        
        // Set up wiring for conditional connections
        setupConditionalWiring();
        
        // Initialize when flows are deployed
        RED.events.on("deploy", function() {
            // Make sure all links have their conditions applied
            RED.nodes.eachLink(function(link) {
                var linkId = link.source.id + ':' + link.sourcePort + ':' + link.target.id;
                if (edgeConditions[linkId]) {
                    updateLinkAppearance(link, edgeConditions[linkId]);
                }
            });
        });
        
        // Add console log to help debug dialog issues
        console.log("Conditional connection system initialized");
    });
    
    // Add this edit connection function to RED namespace for debugging
    RED.editConnection = function(link) {
        if (!link) return;
        
        // Get the link ID
        var linkId = link.source.id + ':' + link.sourcePort + ':' + link.target.id;
        
        // Get or create the condition data
        if (!edgeConditions[linkId]) {
            edgeConditions[linkId] = {
                property: "payload",
                operator: "eq",
                value: "",
                valueType: "str",
                enabled: false
            };
        }
        
        // Show the dialog
        showConnectionDialog(link, edgeConditions[linkId]);
    };
    
    // Add a global debug function
    window.debugEditConnection = function() {
        console.log("Edit connection debug info:");
        
        // Check if RED.editor and RED.editor.editDialog are defined
        console.log("- RED.editor defined:", typeof RED.editor !== 'undefined');
        console.log("- RED.editor.editDialog defined:", typeof RED.editor.editDialog === 'function');
        
        // Check jQuery and jQuery UI
        console.log("- jQuery defined:", typeof jQuery !== 'undefined');
        console.log("- jQuery UI dialog defined:", typeof jQuery.fn.dialog === 'function');
        
        // Check for any selected links
        var selection = RED.view.selection();
        var wireLinks = (selection && selection.links && selection.links.filter(e => !e.link)) || [];
        console.log("- Selected links:", wireLinks.length);
        
        if (wireLinks.length > 0) {
            var selectedLink = wireLinks[0];
            var linkId = selectedLink.source.id + ':' + selectedLink.sourcePort + ':' + selectedLink.target.id;
            console.log("- Selected link ID:", linkId);
            
            // Try to open the dialog for this link
            console.log("- Attempting to show dialog...");
            try {
                RED.editConnection(selectedLink);
                console.log("- Dialog opened without errors");
            } catch (err) {
                console.error("- Error opening dialog:", err);
            }
        } else {
            console.log("- No links selected. Please select a link first.");
        }
        
        return "Debug complete - check console for details";
    };
    
    return {
        show: show,
        hide: disposeMenu,
        evaluateCondition: evaluateCondition,
        getCondition: function(linkId) {
            return edgeConditions[linkId];
        },
        getAllConditions: function() {
            return edgeConditions;
        },
        editConnection: function(link) {
            RED.editConnection(link);
        }
    }
})()
