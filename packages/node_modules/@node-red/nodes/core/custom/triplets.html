<script type="text/javascript">
    RED.nodes.registerType('triplets',{
        category: 'custom',
        color: '#a6bbcf',
        defaults:{
            name:{value:""},
            payload:{value:""},
            enableMqtt: {value: false},
            broker: {type:"mqtt-broker", required:false},
            topic:{value:"", required:false},
            qos: {value:"0"},
            
            // New properties
            prompt: {value:""},
            objective: {value:""},
            customFunction: {value:""},
            
            // Knowledge graph triplet templates - modified format
            enableTemplates: {value: false},
            templates: {value:[{subject:"patient", relation:"hasName", property:"name", valueType:"string"}, 
                               {subject:"patient", relation:"hasAge", property:"age", valueType:"number"}]},
            
            // Storage options
            enableStorage: {value: false},
            storageType: {value:"database"},
            apiEndpoint: {value:""}
        },
        inputs:1,
        outputs:1,
        icon:'bridge.png',
        label:function(){
            return this.name||'triplets';
        },
        labelStyle: function(){
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;
            
            // Handle MQTT visibility
            $("#node-input-enableMqtt").change(function() {
                if ($(this).is(":checked")) {
                    $(".form-row.mqtt-config").show();
                } else {
                    $(".form-row.mqtt-config").hide();
                }
            });
            
            // Handle template visibility
            $("#node-input-enableTemplates").change(function() {
                if ($(this).is(":checked")) {
                    $(".form-row.template-config").show();
                } else {
                    $(".form-row.template-config").hide();
                }
            });
            
            // Handle storage visibility
            $("#node-input-enableStorage").change(function() {
                if ($(this).is(":checked")) {
                    $(".form-row.storage-config").show();
                } else {
                    $(".form-row.storage-config").hide();
                }
            });
            
            // Initialize template table
            var templateContainer = $("#node-input-template-container");
            
            // Load templates
            if (node.templates && node.templates.length) {
                for (var i=0; i<node.templates.length; i++) {
                    addTemplateRow(node.templates[i]);
                }
            } else {
                // Add default rows if none exist
                addTemplateRow({subject:"patient", relation:"hasName", property:"name", valueType:"string"});
                addTemplateRow({subject:"patient", relation:"hasAge", property:"age", valueType:"number"});
            }
            
            // Setup add button
            $("#node-input-add-template").click(function() {
                addTemplateRow({subject:"", relation:"", property:"", valueType:"string"});
            });
            
            function addTemplateRow(template) {
                var container = $('<div/>',{class:"form-row template-row"});
                
                // Subject input
                var subjectField = $('<input/>',{class:"node-input-template-subject", type:"text"})
                    .css({"width":"20%", "margin-right":"5px"})
                    .attr("placeholder", "Subject")
                    .val(template.subject || "");
                
                // Relation input
                var relationField = $('<input/>',{class:"node-input-template-relation", type:"text"})
                    .css({"width":"20%", "margin-right":"5px"})
                    .attr("placeholder", "Relation")
                    .val(template.relation || "");
                
                // Property input
                var propertyField = $('<input/>',{class:"node-input-template-property", type:"text"})
                    .css({"width":"20%", "margin-right":"5px"})
                    .attr("placeholder", "Property")
                    .val(template.property || "");
                
                // Value Type select
                var typeSelect = $('<select/>',{class:"node-input-template-type"})
                    .css({"width":"15%", "margin-right":"5px"});
                    
                typeSelect.append($("<option></option>").val("string").text("String"));
                typeSelect.append($("<option></option>").val("number").text("Number"));
                typeSelect.append($("<option></option>").val("date").text("Date"));
                typeSelect.append($("<option></option>").val("boolean").text("Boolean"));
                typeSelect.val(template.valueType || "string");
                
                // Delete button
                var deleteButton = $('<a/>',{href:"#", class:"editor-button editor-button-small"})
                    .append($('<i/>',{class:"fa fa-remove"}))
                    .click(function(e) {
                        e.preventDefault();
                        container.remove();
                    });
                
                container.append(subjectField)
                         .append(relationField)
                         .append(propertyField)
                         .append(typeSelect)
                         .append(deleteButton);
                         
                templateContainer.append(container);
            }
            
            // Initialize state
            if (!this.enableMqtt) {
                $(".form-row.mqtt-config").hide();
            }
            
            if (!this.enableTemplates) {
                $(".form-row.template-config").hide();
            }
            
            if (!this.enableStorage) {
                $(".form-row.storage-config").hide();
            }
        },
        oneditsave: function() {
            var node = this;
            var templates = [];
            
            $(".template-row").each(function() {
                var row = $(this);
                var subject = row.find(".node-input-template-subject").val();
                var relation = row.find(".node-input-template-relation").val();
                var property = row.find(".node-input-template-property").val();
                var valueType = row.find(".node-input-template-type").val();
                
                if (subject && relation && property) {
                    templates.push({
                        subject: subject,
                        relation: relation,
                        property: property,
                        valueType: valueType
                    });
                }
            });
            
            node.templates = templates;
        }
    });

</script>

<script type="text/html" data-template-name = "triplets">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <div class="form-row">
        <label for="node-input-payload"><i class="fa fa-envelope"></i> Payload</label>
        <input type="text" id="node-input-payload" placeholder="Default payload">
    </div>
    
    <!-- Processing Options Section - Prompt and Objective -->
    <div class="form-row">
        <label for="node-input-prompt"><i class="fa fa-comment"></i> Prompt</label>
        <input type="text" id="node-input-prompt" placeholder="Prompt text">
    </div>
    
    <div class="form-row">
        <label for="node-input-objective"><i class="fa fa-bullseye"></i> Objective</label>
        <input type="text" id="node-input-objective" placeholder="Define the objective">
    </div>
    
    <!-- MQTT Section -->
    <div class="form-row">
        <label for="node-input-enableMqtt"><i class="fa fa-toggle-on"></i> Enable MQTT</label>
        <input type="checkbox" id="node-input-enableMqtt" style="display:inline-block; width:auto; vertical-align:top;">
    </div>
    <div class="form-row mqtt-config">
        <label for="node-input-broker"><i class="fa fa-globe"></i> Broker</label>
        <input type="text" id="node-input-broker">
    </div>
    <div class="form-row mqtt-config">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> Topic</label>
        <input type="text" id="node-input-topic" placeholder="topic">
    </div>
    <div class="form-row mqtt-config">
        <label for="node-input-qos"><i class="fa fa-empire"></i> QoS</label>
        <select id="node-input-qos" style="width:125px !important">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
        </select>
    </div>
    
    <!-- Knowledge Graph Triplet Templates Section - Modified -->
    <div class="form-row">
        <label for="node-input-enableTemplates"><i class="fa fa-th"></i> Enable Templates</label>
        <input type="checkbox" id="node-input-enableTemplates" style="display:inline-block; width:auto; vertical-align:top;">
    </div>
    <div class="form-row template-config" style="margin-bottom:0;">
        <label><i class="fa fa-list"></i> Triplet Templates</label>
        <a href="#" class="editor-button editor-button-small" id="node-input-add-template" style="margin-top:4px;">
            <i class="fa fa-plus"></i> Add
        </a>
    </div>
    <div class="form-row template-config">
        <div class="form-row" style="margin-bottom: 0px;">
            <div style="padding-left: 110px; display: flex; width: 100%; box-sizing: border-box;">
                <div style="width: 20%; margin-right: 5px; font-weight: bold;">Subject</div>
                <div style="width: 20%; margin-right: 5px; font-weight: bold;">Relation</div>
                <div style="width: 20%; margin-right: 5px; font-weight: bold;">Property</div>
                <div style="width: 15%; margin-right: 5px; font-weight: bold;">Type</div>
            </div>
        </div>
        <div style="padding-left: 110px; min-height: 30px;" id="node-input-template-container">
            <!-- Template rows will be added here -->
        </div>
    </div>
    
    <!-- Storage Options Section -->
    <div class="form-row">
        <label for="node-input-enableStorage"><i class="fa fa-database"></i> Enable Storage</label>
        <input type="checkbox" id="node-input-enableStorage" style="display:inline-block; width:auto; vertical-align:top;">
    </div>
    <div class="form-row storage-config">
        <label for="node-input-storageType"><i class="fa fa-table"></i> Storage Type</label>
        <select id="node-input-storageType" style="width:70%;">
            <option value="database">Database</option>
            <option value="knowledge-graph">Knowledge Graph</option>
            <option value="file">File</option>
        </select>
    </div>
    <div class="form-row storage-config">
        <label for="node-input-apiEndpoint"><i class="fa fa-link"></i> API Endpoint</label>
        <input type="text" id="node-input-apiEndpoint" placeholder="http://your-api-endpoint">
    </div>
    
    <!-- Custom Function Section - Moved to the end -->
    <div class="form-row">
        <label for="node-input-customFunction"><i class="fa fa-code"></i> Function</label>
        <textarea id="node-input-customFunction" rows="8" style="width:70%" placeholder="// Define multiple functions here
function processData(data) {
    // Process your data
    return data;
}

// Main processing code
const result = processData(msg.payload);
msg.processed = true;

// Return the modified message
return msg;"></textarea>
    </div>
</script>

<script type="text/html" data-help-name = "triplets">
    <p>A node that processes input messages and creates knowledge graph triplets with customizable templates.</p>
    
    <h3>Features</h3>
    <ul>
        <li><b>Input Processing:</b> Processes incoming flow messages, applying the configured default payload.</li>
        <li><b>MQTT (Optional):</b> Subscribe to MQTT topics when enabled.</li>
        <li><b>Knowledge Graph Templates:</b> Define triplets in subject-relation-object format with properties from incoming messages.</li>
        <li><b>Storage Integration:</b> Save triplets to databases or knowledge graphs using API endpoints.</li>
    </ul>
    
    <h3>Triplet Format</h3>
    <p>Each triplet template consists of:</p>
    <ul>
        <li><b>Subject:</b> The entity that the triplet refers to (e.g., "patient", "device")</li>
        <li><b>Relation:</b> The relationship/predicate between subject and object (e.g., "hasName", "hasAge")</li>
        <li><b>Property:</b> The property name in the incoming message to extract the value from</li>
        <li><b>Type:</b> The data type (string, number, boolean, date) to convert the value to</li>
    </ul>
    
    <h3>Example</h3>
    <p>For incoming message: <code>{"name": "John", "age": 42}</code></p>
    <p>With templates:</p>
    <ul>
        <li>subject: "patient", relation: "hasName", property: "name", type: "string"</li>
        <li>subject: "patient", relation: "hasAge", property: "age", type: "number"</li>
    </ul>
    <p>Produces triplets:</p>
    <ul>
        <li>(patient, hasName, "John")</li>
        <li>(patient, hasAge, 42)</li>
    </ul>
</script>