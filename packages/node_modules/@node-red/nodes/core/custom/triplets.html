<script type="text/javascript">
    // Add custom CSS to make the property sheet wider when the node is edited
    RED.events.on("editor:open", function(node) {
        if (node.type === "triplets") {
            // Add custom style to make the dialog wider
            if (!$('#triplet-dialog-styles').length) {
                $('head').append(
                    '<style id="triplet-dialog-styles">' +
                    // Make the dialog much wider
                    '.red-ui-editor .red-ui-tray-content { width: 850px !important; }' +
                    // Adjust the content area
                    '.red-ui-editor .red-ui-tray-content .red-ui-tray-content-content { width: 850px !important; }' +
                    // Make form inputs wider
                    '.red-ui-editor .form-row input, .red-ui-editor .form-row select { width: 70%; }' +
                    // Fix the node-input-broker special case
                    '.form-row input[type="hidden"] + div.red-ui-typedInput-container { width: 70% !important; }' +
                    // Ensure the tray opens wider
                    '.red-ui-editor-stack { right: calc(100% - 850px) !important; }' +
                    // Adjust the tray footer
                    '.red-ui-editor .red-ui-tray-footer { width: 850px; }' +
                    // Fix select2 styling for triplet rows
                    '.template-row .select2-container { width: 100% !important; }' +
                    '.template-row .select2-container .select2-selection { height: 36px !important; }' +
                    '.template-row .select2-container .select2-selection .select2-selection__rendered { line-height: 36px !important; }' +
                    '.template-row .select2-container .select2-selection .select2-selection__arrow { height: 36px !important; }' +
                    '</style>'
                );
            }
        }
    });

    RED.events.on("editor:close", function(node) {
        if (node.type === "triplets") {
            // Remove custom styles when editor closes
            $('#triplet-dialog-styles').remove();
        }
    });

    RED.nodes.registerType('triplets',{
        category: 'custom',
        color: '#a6bbcf',
        defaults:{
            name:{value:""},
            payload:{value:""},
            broker: {type:"mqtt-broker", required:true},
            topic:{value:"", required:true},
            qos: {value:"0"},
            
            // New properties
            prompt: {value:""},
            objective: {value:""},
            
            // Knowledge graph triplet templates - updated format
            templates: {value:[
                {subject:"Patient", predicate:"has_appointment_with", object:"msg.payload.name", enableStorage: false}, 
                {subject:"Patient", predicate:"has_symptom", object:"msg.payload.symptom", enableStorage: false}
            ]},
            
            // Storage options (common API endpoint)
            apiEndpoint: {value:""},
            
            // Custom functions
            functions: {value:[
                {name:"Function 1", code:""}
            ]}
        },
        inputs:1,
        outputs:1,
        icon:'bridge.png',
        label:function(){
            return this.name||'triplets';
        },
        labelStyle: function(){
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;
            
            // Load triplets data from the JSON file
            $.getJSON('custom/triplets_data.json')
                .done(function(data) {
                    // Store data in global variables for easier access
                    window.tripletEntities = data.entities || [];
                    window.tripletRelations = data.relations || [];
                    
                    // Initialize the template container
                    initializeTemplates();
                })
                .fail(function(jqxhr, textStatus, error) {
                    // Log the error but continue with empty arrays
                    console.error("Failed to load triplets_data.json:", error);
                    window.tripletEntities = [];
                    window.tripletRelations = [];
                    
                    // Still initialize templates
                    initializeTemplates();
                });
                
            function initializeTemplates() {
                var templateContainer = $("#node-input-template-container");
                templateContainer.empty();
                
                // Load templates
                if (node.templates && node.templates.length) {
                    for (var i=0; i<node.templates.length; i++) {
                        addTemplateRow(node.templates[i]);
                    }
                } else {
                    // Add default rows if none exist
                    addTemplateRow({subject:"Patient", predicate:"has_appointment_with", object:"msg.payload.name", enableStorage: false});
                    addTemplateRow({subject:"Patient", predicate:"has_symptom", object:"msg.payload.symptom", enableStorage: false});
                }
            }
            
            // Setup add template button
            $("#node-input-add-template").click(function() {
                addTemplateRow({subject:"", predicate:"", object:"", enableStorage: false});
            });
            
            function addTemplateRow(template) {
                // Create a clean, compact row container
                var container = $('<div/>',{class:"form-row template-row"}).css({
                    "margin-bottom": "8px",
                    "position": "relative",
                    "padding": "6px 8px",
                    "background-color": "#f9f9f9",
                    "border-radius": "4px",
                    "display": "flex",
                    "align-items": "center",
                    "flex-wrap": "nowrap"
                });
                
                // Subject dropdown - equal width
                var subjectField = $('<select/>',{class:"node-input-template-subject"})
                    .css({
                        "flex": "1",
                        "margin-right": "8px",
                        "height": "36px",
                        "padding": "6px",
                        "font-size": "14px",
                        "min-width": "0" // Allows flex to work properly
                    });
                
                // Add entities as options
                subjectField.append($('<option value="">-- Subject --</option>'));
                if (window.tripletEntities && window.tripletEntities.length) {
                    window.tripletEntities.forEach(function(entity) {
                        var option = $('<option/>').text(entity).val(entity);
                        if (template.subject === entity) {
                            option.attr('selected', 'selected');
                        }
                        subjectField.append(option);
                    });
                }
                
                // Predicate dropdown - equal width
                var predicateField = $('<select/>',{class:"node-input-template-predicate"})
                    .css({
                        "flex": "1",
                        "margin-right": "8px",
                        "height": "36px",
                        "padding": "6px",
                        "font-size": "14px",
                        "min-width": "0" // Allows flex to work properly
                    });
                
                // Add relations as options
                predicateField.append($('<option value="">-- Predicate --</option>'));
                if (window.tripletRelations && window.tripletRelations.length) {
                    window.tripletRelations.forEach(function(relation) {
                        var option = $('<option/>').text(relation).val(relation);
                        if (template.predicate === relation) {
                            option.attr('selected', 'selected');
                        }
                        predicateField.append(option);
                    });
                }
                
                // Object input - equal width
                var objectField = $('<input/>',{
                    class:"node-input-template-object",
                    type:"text"
                })
                .css({
                    "flex": "1",
                    "margin-right": "8px",
                    "height": "36px",
                    "padding": "6px 10px",
                    "font-size": "14px",
                    "min-width": "0" // Allows flex to work properly
                })
                .attr("placeholder", "Object (e.g., msg.payload.value)")
                .val(template.object || "");
                
                // Storage checkbox in a compact container
                var storageContainer = $('<div/>').css({
                    "display": "flex",
                    "align-items": "center",
                    "margin-right": "8px",
                    "white-space": "nowrap"
                });
                
                var storageCheckbox = $('<input/>',{
                    class:"node-input-template-storage",
                    type:"checkbox",
                    id: "storage-" + Date.now() // Unique ID for label association
                })
                .css({
                    "margin": "0 5px 0 0"
                })
                .prop("checked", template.enableStorage === true);
                
                var storageLabel = $('<label/>')
                    .attr("for", storageCheckbox.attr("id"))
                    .text("Store")
                    .css({
                        "font-weight": "normal",
                        "font-size": "14px",
                        "margin": "0",
                        "cursor": "pointer"
                    });
                
                storageContainer.append(storageCheckbox).append(storageLabel);
                
                // Delete button - compact design
                var deleteButton = $('<a/>',{href:"#", class:"editor-button editor-button-small"})
                    .append($('<i/>',{class:"fa fa-trash"}))
                    .css({
                        "padding": "6px 8px",
                        "margin-left": "auto"
                    })
                    .click(function(e) {
                        e.preventDefault();
                        container.remove();
                    });
                
                // Add all elements to the container
                container.append(subjectField)
                         .append(predicateField)
                         .append(objectField)
                         .append(storageContainer)
                         .append(deleteButton);
                
                // Add the container to the template container
                $("#node-input-template-container").append(container);
                
                // Initialize select2 for searchable dropdowns if available
                if ($.fn.select2) {
                    var select2Config = {
                        placeholder: "Select...",
                        allowClear: true,
                        tags: true,
                        width: '100%',
                        dropdownAutoWidth: false
                    };
                    
                    subjectField.select2(select2Config);
                    predicateField.select2(select2Config);
                }
            }
            
            // Initialize function editors
            var functionContainer = $("#node-input-function-container");
            functionContainer.empty();
            var functionEditors = {};
            var functionCounter = 0;
            
            // Load functions
            if (node.functions && node.functions.length) {
                for (var i=0; i<node.functions.length; i++) {
                    addFunctionRow(node.functions[i], functionCounter++);
                }
            } else {
                // Add a default function if none exists
                addFunctionRow({
                    name: "Function 1",
                    code: ""
                }, functionCounter++);
            }
            
            // Setup add function button
            $("#node-input-add-function").click(function() {
                addFunctionRow({
                    name: "Function " + (functionCounter + 1),
                    code: ""
                }, functionCounter++);
            });
            
            function addFunctionRow(functionDef, id) {
                var container = $('<div/>',{class:"form-row function-row", id:"function-row-" + id});
                
                // Function name
                var headerRow = $('<div/>',{class:"form-row function-header-row"});
                var functionLabel = $('<span/>').text("Function Name: ").css({"margin-right":"10px"});
                var nameField = $('<input/>',{
                    class:"node-input-function-name",
                    type:"text",
                    id: "node-input-function-name-" + id
                })
                .css({"width":"50%", "margin-right":"10px", "height": "34px", "padding": "4px 8px"})
                .attr("placeholder", "Function Name")
                .val(functionDef.name || "");
                
                // Delete button
                var deleteButton = $('<a/>',{href:"#", class:"editor-button editor-button-small"})
                    .append($('<i/>',{class:"fa fa-trash fa-lg"}))
                    .css({
                        "padding": "6px 10px"
                    })
                    .click(function(e) {
                        e.preventDefault();
                        
                        // Remove the editor from the registry
                        delete functionEditors["function-editor-" + id];
                        
                        // Remove the container and its separator
                        container.next("hr").remove();
                        container.remove();
                    });
                
                headerRow.append(functionLabel)
                         .append(nameField)
                         .append(deleteButton);
                
                // Code editor
                var editorRow = $('<div/>',{class:"form-row", style:"position:relative"});
                var editorContainer = $('<div/>',{
                    style:"width: 100%; height: 300px; min-height:200px;",
                    class:"node-text-editor",
                    id: "node-input-function-editor-" + id
                });
                
                editorRow.append(editorContainer);
                
                container.append(headerRow)
                         .append(editorRow);
                
                // Add a separator before each function (except the first one)
                if (functionContainer.children().length > 0) {
                    functionContainer.append($('<hr/>',{style:"margin-top:20px; margin-bottom:20px;"}));
                }
                         
                functionContainer.append(container);
                
                // Setup ACE editor
                var editor = RED.editor.createEditor({
                    id: "node-input-function-editor-" + id,
                    mode: "ace/mode/javascript",
                    value: functionDef.code || ""
                });
                
                // Store the editor reference
                functionEditors["function-editor-" + id] = editor;
            }
            
            // Store editor references
            this.functionEditors = functionEditors;
        },
        oneditsave: function() {
            var node = this;
            
            // Save templates
            var templates = [];
            
            $(".template-row").each(function() {
                var row = $(this);
                var subject = row.find(".node-input-template-subject").val();
                var predicate = row.find(".node-input-template-predicate").val();
                var object = row.find(".node-input-template-object").val();
                var enableStorage = row.find(".node-input-template-storage").is(":checked");
                
                if (subject && predicate && object) {
                    templates.push({
                        subject: subject,
                        predicate: predicate,
                        object: object,
                        enableStorage: enableStorage
                    });
                }
            });
            
            node.templates = templates;
            
            // Save functions
            var functions = [];
            
            $(".function-row").each(function() {
                var id = $(this).attr("id").replace("function-row-", "");
                var name = $(this).find(".node-input-function-name").val() || "Function";
                var editor = node.functionEditors["function-editor-" + id];
                var code = editor ? editor.getValue() : "";
                
                functions.push({
                    name: name,
                    code: code
                });
            });
            
            node.functions = functions;
            
            // Remove custom styles when closing the dialog
            $('#triplet-dialog-styles').remove();
        },
        oneditcancel: function() {
            // Cleanup ACE editors when the dialog is cancelled
            if (this.functionEditors) {
                for (var id in this.functionEditors) {
                    if (this.functionEditors.hasOwnProperty(id)) {
                        this.functionEditors[id].destroy();
                    }
                }
            }
            
            // Remove custom styles when closing the dialog
            $('#triplet-dialog-styles').remove();
        },
        oneditdelete: function() {
            // Cleanup ACE editors when the node is deleted
            if (this.functionEditors) {
                for (var id in this.functionEditors) {
                    if (this.functionEditors.hasOwnProperty(id)) {
                        this.functionEditors[id].destroy();
                    }
                }
            }
            
            // Remove custom styles when closing the dialog
            $('#triplet-dialog-styles').remove();
        }
    });

</script>

<script type="text/html" data-template-name = "triplets">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <div class="form-row">
        <label for="node-input-payload"><i class="fa fa-envelope"></i> Payload</label>
        <input type="text" id="node-input-payload" placeholder="Default payload">
    </div>
    
    <!-- Processing Options Section - Prompt and Objective -->
    <div class="form-row">
        <label for="node-input-prompt"><i class="fa fa-comment"></i> Prompt</label>
        <input type="text" id="node-input-prompt" placeholder="Prompt text">
    </div>
    
    <div class="form-row">
        <label for="node-input-objective"><i class="fa fa-bullseye"></i> Objective</label>
        <input type="text" id="node-input-objective" placeholder="Define the objective">
    </div>
    
    <!-- MQTT Section - Always visible, no checkbox -->
    <div class="form-row">
        <label for="node-input-broker"><i class="fa fa-globe"></i> MQTT Broker</label>
        <input type="text" id="node-input-broker">
    </div>
    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> MQTT Topic</label>
        <input type="text" id="node-input-topic" placeholder="topic">
    </div>
    <div class="form-row">
        <label for="node-input-qos"><i class="fa fa-empire"></i> QoS</label>
        <select id="node-input-qos" style="width:125px !important">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
        </select>
    </div>
    
    <!-- Knowledge Graph Triplet Templates Section -->
    <!-- API Endpoint (Common for all templates) -->
    <div class="form-row">
        <label for="node-input-apiEndpoint"><i class="fa fa-link"></i> API Endpoint for triplets</label>
        <input type="text" id="node-input-apiEndpoint" placeholder="http://your-api-endpoint">
    </div>
    
    <!-- Triplet templates section with header and add button -->
    <div class="form-row">
        <label><i class="fa fa-list"></i> Triplet Templates</label>
        <a href="#" class="editor-button editor-button-small" id="node-input-add-template" style="margin-top:4px; padding: 4px 10px;">
            <i class="fa fa-plus"></i> Add
        </a>
    </div>
    
    <!-- Compact template header row -->
    <div class="form-row" style="margin-top:10px; margin-bottom:5px; padding: 0 8px;">
        <div style="display: flex; width: 100%; padding-left: 100px; box-sizing: border-box;">
            <div style="flex: 1; margin-right: 8px; font-weight: bold; font-size: 14px;">Subject</div>
            <div style="flex: 1; margin-right: 8px; font-weight: bold; font-size: 14px;">Predicate</div>
            <div style="flex: 1; margin-right: 8px; font-weight: bold; font-size: 14px;">Object</div>
            <div style="margin-right: 8px; font-weight: bold; font-size: 14px;">Store</div>
            <div style="width: 40px;"></div>
        </div>
    </div>
    
    <!-- Template container with compact styling -->
    <div style="padding-left: 100px; min-height: 120px; margin-bottom: 15px;" id="node-input-template-container">
        <!-- Template rows will be added here -->
    </div>
    
    <!-- Custom Functions Section -->
    <div class="form-row" style="margin-top:20px; margin-bottom:0;">
        <label><i class="fa fa-code"></i> Custom Functions</label>
    </div>
    <div id="node-input-function-container">
        <!-- Function editors will be added here -->
    </div>
    <div class="form-row" style="margin-top:15px;">
        <div style="display: flex; justify-content: center; width: 100%;">
            <a href="#" class="editor-button" id="node-input-add-function" style="padding: 8px 15px; font-size: 14px;">
                <i class="fa fa-plus"></i> Add Function
            </a>
        </div>
    </div>
</script>

<script type="text/html" data-help-name = "triplets">
    <p>A node that processes input messages and creates knowledge graph triplets with customizable templates.</p>
    
    <h3>Features</h3>
    <ul>
        <li><b>Input Processing:</b> Processes incoming flow messages, applying the configured default payload.</li>
        <li><b>MQTT Integration:</b> Always connects to MQTT topics for message input and output.</li>
        <li><b>Knowledge Graph Templates:</b> Define triplets in subject-predicate-object format with dynamic values from message paths.</li>
        <li><b>Individual Storage Options:</b> Each triplet can be individually configured for storage using the common API endpoint.</li>
        <li><b>Custom Functions:</b> Add multiple JavaScript functions to process messages with full access to Node-RED context variables.</li>
    </ul>
    
    <h3>Triplet Format</h3>
    <p>Each triplet template consists of:</p>
    <ul>
        <li><b>Subject:</b> The entity that the triplet refers to (select from dropdown with predefined values from triplets_data.json)</li>
        <li><b>Predicate:</b> The relationship between subject and object (select from dropdown with predefined values from triplets_data.json)</li>
        <li><b>Object:</b> The object value or a path to extract from the message (e.g., "msg.payload.name")</li>
        <li><b>Store:</b> Whether to store this triplet via the API endpoint</li>
    </ul>
    
    <h3>Dynamic Values</h3>
    <p>You can use paths like "msg.payload.value" or "msg.topic" in the object field to dynamically extract values from incoming messages.</p>
    
    <h3>Subject and Predicate Options</h3>
    <p>The subject and predicate dropdowns are populated from the triplets_data.json file, which contains predefined entities and relations.</p>
    
    <h3>Storage</h3>
    <p>Triplets marked for storage will be sent to the configured API endpoint. All triplets use the same endpoint, but you can choose which ones to store individually.</p>
    
    <h3>Custom Functions</h3>
    <p>Add JavaScript functions to process messages. Each function has access to:</p>
    <ul>
        <li><b>msg:</b> The message object being processed</li>
        <li><b>node:</b> A reference to the node itself</li>
        <li><b>context:</b> The node's context storage</li>
        <li><b>flow:</b> The flow context storage</li>
        <li><b>global:</b> The global context storage</li>
    </ul>
    <p>Functions should return the message object to pass it to the next node.</p>
    
    <h3>Example</h3>
    <p>For incoming message: <code>{"payload": {"name": "John", "symptom": "Headache"}}</code></p>
    <p>With templates:</p>
    <ul>
        <li>subject: "Patient", predicate: "has_appointment_with", object: "msg.payload.name"</li>
        <li>subject: "Patient", predicate: "has_symptom", object: "msg.payload.symptom"</li>
    </ul>
    <p>Produces triplets:</p>
    <ul>
        <li>(Patient, has_appointment_with, "John")</li>
        <li>(Patient, has_symptom, "Headache")</li>
    </ul>
</script>